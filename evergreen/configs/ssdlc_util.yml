# This file contains common SSDLC-related functions and tasks that are useful across multiple
# SQL Engines Evergreen projects. The functions in this config file depend on one or more of the
# following expansions:
#  - working_dir - the working directory in which a function should run
#  - script_dir - the path to the subdirectory containing the shared test infra scripts
#  - compliance_report_template_path - the path to the compliance report template
#  - release_version - the version (snapshot or release version) of the product being built
#  - author - the author of the changes (set by Evergreen)
#  - author_email - the email of the author of the changes (set by Evergreen)
#. - ALLOW_VULNS - known vulnerabilities to ignore during scanning
#  - COMPLIANCE_REPORT_NAME - the name of the compliance report being generated (generated by create-ssdlc-expansions.sh)
#  - SBOM_DIR - the directory to output sbom files to (generated by create-ssdlc-expansions.sh)
#  - SBOM_LICENSES - the name of the intermediate license file to scan (generated by create-ssdlc-expansions.sh)
#  - STATIC_CODE_ANALYSIS_NAME - the name of the file to output semgrep static analysis
#  - SBOM_FILENAME - the name of the sbom file to add to the compliance report (generated by create-ssdlc-expansions.sh)
#  - github_repo - the name of the github repository (set by Evergreen)
#  - product_name - the name of the product for the compliance report title
#  - signing_section_bookmark - the bookmark name for the signing section in the repositories readme
#  - semgrep_app_token - the semgrep app token to use for static code analysis, set in evergreen project settings

variables:
  - &rust_subprocess_default_params
      working_dir: ${working_dir}
      PRODUCT_NAME: ${PRODUCT_NAME}
      binary: bash
  - &assume_role_cmd
    command: ec2.assume_role
    params:
      role_arn: ${assume_role_arn}
      duration_seconds: 3600
  - &evg_bucket_config
    aws_key: ${AWS_ACCESS_KEY_ID}
    aws_secret: ${AWS_SECRET_ACCESS_KEY}
    aws_session_token: ${AWS_SESSION_TOKEN}

functions:
  "create ssdlc expansions":
    - command: subprocess.exec
      params:
        add_expansions_to_env: true
        binary: bash
        args:
          - ${script_dir}/create-ssdlc-expansions.sh
    - command: expansions.update
      params:
        file: ${working_dir}/ssdlc-expansions.yml

  # Generates the compliance report. Requires working_dir and compliance_report_template_path to be
  # set appropriately. Also requires any expansions listed below that are referenced by the calling
  # repository's compliance report template.
  #
  # Arguments:
  #  - put_to_bucket - optional. defaults to mciuploads. the bucket in which to put the compliance report
  #  - published_sbom_path - the published SBOM path in S3
  #  - published_sarif_path - the published static code analysis path in S3
  "generate compliance report":
    - command: subprocess.exec
      type: test
      params:
        <<: *rust_subprocess_default_params
        include_expansions_in_env:
          - author
          - author_email
          - release_version
          - github_repo
          - product_name
          - signing_section_bookmark
          - working_dir
          - compliance_report_template_path
          - COMPLIANCE_REPORT_NAME
          - published_sbom_path
          - published_sarif_path
        args:
          - ${script_dir}/generate_compliance_report.sh
    - *assume_role_cmd
    - command: s3.put
      params:
        <<: *evg_bucket_config
        local_file: ${working_dir}/${COMPLIANCE_REPORT_NAME}
        remote_file: ${working_dir}/artifacts/${version_id}/ssdlc/${COMPLIANCE_REPORT_NAME}
        content_type: text/markdown
        bucket: ${put_to_bucket|mciuploads}
        permissions: public-read

  # Publishes the compliance report. Requires the working_dir and COMPLIANCE_REPORT_NAME expansions
  # to be set appropriately.
  #
  # Arguments:
  #  - get_from_bucket - optional. defaults to mciuploads. the bucket from which to get the file that was created by the
  #                      "generate compliance report" function
  #  - local_file_path - The path to the local file for downloading from/uploading to S3
  #  - published_file_path - The remote file path for uploading to S3
  "publish compliance report":
    - *assume_role_cmd
    - command: s3.get
      params:
        <<: *evg_bucket_config
        local_file: ${local_file_path}
        remote_file: ${working_dir}/artifacts/${version_id}/ssdlc/${COMPLIANCE_REPORT_NAME}
        content_type: text/markdown
        bucket: ${get_from_bucket|mciuploads}
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: ${local_file_path}
        remote_file: ${published_file_path}
        content_type: text/markdown
        bucket: translators-connectors-releases
        permissions: public-read
        display_name: ${COMPLIANCE_REPORT_NAME}

  # Scans SBOM for vulnerabilities, allowing any vulnerabilities listed in the ALLOW_VULNS
  # expansion. Requires working_dir and SBOM_DIR to be set appropriately.
  #
  # Arguments:
  #  - sbom_path - the path to the sbom file to scan
  "scan SBOM":
    - command: subprocess.exec
      type: test
      params:
        <<: *rust_subprocess_default_params
        include_expansions_in_env:
          - working_dir
          - ALLOW_VULNS
          - SBOM_DIR
          - sbom_path
        args:
          - ${script_dir}/scan_sbom.sh

  "write aws credentials to file for silkbomb":
    - command: ec2.assume_role
      display_name: Assume IAM role with permissions to get AWS credentials for Silkbomb
      params:
        role_arn: ${silkbomb_role_arn}
    - command: shell.exec
      display_name: Write AWS credentials to file for Silkbomb
      params:
        silent: true
        shell: bash
        include_expansions_in_env:
          - AWS_ACCESS_KEY_ID
          - AWS_SECRET_ACCESS_KEY
          - AWS_SESSION_TOKEN
        script: |
          cat <<EOF > ${working_dir}/aws_vars.env
          AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
          AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN
          EOF

  # Augments SBOM file and uploads to S3. Requires the working_dir and script_dir expansions to be set appropriately.
  #
  # Arguments:
  #  - put_to_bucket - optional. defaults to mciuploads. the bucket in which to put the augmented file
  #  - sbom_in_path - The path to the input SBOM file
  #  - sbom_out_path - The path to the output SBOM file, relative to ${working_dir} (e.g. ODBC should just use
  #                    ${AUGMENTED_SBOM_FILENAME}, whereas JDBC should use artifacts/ssdlc/${AUGMENTED_SBOM_FILENAME})
  "augment SBOM":
    - command: subprocess.exec
      type: test
      params:
        working_dir: ${working_dir}
        binary: bash
        add_expansions_to_env: true
        args:
          - ${script_dir}/augment_sbom.sh
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: ${working_dir}/${sbom_out_path}
        remote_file: ${working_dir}/artifacts/${version_id}/ssdlc/${AUGMENTED_SBOM_FILENAME}
        content_type: application/json
        bucket: ${put_to_bucket|mciuploads}
        permissions: public-read

  # Publishes the augmented SBOM file. Requires the working_dir, AUGMENTED_SBOM_FILENAME, and
  # SBOM_FILENAME expansions to be set appropriately.
  #
  # Arguments:
  #  - get_from_bucket - optional. defaults to mciuploads. the bucket from which to get the file that was created by the
  #                      "augment sbom" function
  #  - local_file_path - The path to the local file for downloading from/uploading to S3
  #  - published_file_path - The remote file path for uploading to S3
  "publish augmented SBOM":
    - *assume_role_cmd
    - command: s3.get
      params:
        <<: *evg_bucket_config
        local_file: ${local_file_path}
        remote_file: ${working_dir}/artifacts/${version_id}/ssdlc/${AUGMENTED_SBOM_FILENAME}
        content_type: application/json
        bucket: ${get_from_bucket|mciuploads}
        permissions: public-read
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: ${local_file_path}
        remote_file: ${published_file_path}
        bucket: translators-connectors-releases
        content_type: application/json
        permissions: public-read
        display_name: ${SBOM_FILENAME}

  # Generates static code analysis file(s). Requires the working_dir and STATIC_CODE_ANALYSIS_NAME
  # expansions to be set appropriately. Also requires the semgrep_app_token variable to be set in
  # the evergreen project settings.
  #
  # Arguments:
  #  - put_to_bucket - optional. defaults to mciuploads. the bucket in which to put the generated file
  "generate static code analysis":
    - command: subprocess.exec
      type: test
      params:
        <<: *rust_subprocess_default_params
        include_expansions_in_env:
          - semgrep_app_token
          - working_dir
          - STATIC_CODE_ANALYSIS_NAME
        args:
          - ${script_dir}/generate_static_code_analysis.sh
    - *assume_role_cmd
    - command: s3.put
      params:
        <<: *evg_bucket_config
        local_files_include_filter:
          - ${STATIC_CODE_ANALYSIS_NAME}*
        remote_file: ${working_dir}/artifacts/${version_id}/ssdlc/
        content_type: application/json
        bucket: ${put_to_bucket|mciuploads}
        permissions: public-read

  # Publishes the static code analysis file. Requires the working_dir and STATIC_CODE_ANALYSIS_NAME
  # expansions to be set appropriately.
  #
  # Arguments:
  #  - get_from_bucket - optional. defaults to mciuploads. the bucket from which to get the file that was created by the
  #                      "generate static code analysis" function
  #  - local_file_path - The path to the local file for downloading from/uploading to S3
  #  - published_file_path - The remote file path for uploading to S3
  "publish static code analysis":
    - *assume_role_cmd
    - command: s3.get
      params:
        <<: *evg_bucket_config
        local_file: ${local_file_path}
        remote_file: ${working_dir}/artifacts/${version_id}/ssdlc/${STATIC_CODE_ANALYSIS_NAME}
        content_type: application/json
        bucket: ${get_from_bucket|mciuploads}
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: ${local_file_path}
        remote_file: ${published_file_path}
        content_type: application/json
        bucket: translators-connectors-releases
        permissions: public-read
        display_name: ${STATIC_CODE_ANALYSIS_NAME}
