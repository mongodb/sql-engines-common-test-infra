# Evergreen Project Config

# When a task that used to pass starts to fail go through all versions that may
# have been skipped to detect when the task started failing.
stepback: true

# Mark a failure as a system/bootstrap failure (purple box) rather than a task
# failure by default.
# Actual testing tasks are marked with `type: test`
command_type: system

# If any of the pre tasks fail, the task will be marked as a failure.
pre_error_fails_task: true

# Do not create patches for changes that only modify the following file types
ignore:
  - "*.md"

# Protect ourselves against rogue test cases, or curl gone wild, that runs forever
exec_timeout_secs: 86400 # 24hrs for TPC-H benchmark

# What to do when evergreen hits the timeout (`post:` tasks are run automatically)
timeout:
  - command: shell.exec
    params:
      script: |
        ls -la

include:
  - filename: evergreen/configs/rust_util.yml

pre:
  - func: "fetch source"
  - func: "create expansions"

functions:
  "fetch source":
    - command: git.get_project
      params:
        directory: sql-engines-common-test-infra

  "create expansions":
    - command: shell.exec
      params:
        shell: bash
        working_dir: sql-engines-common-test-infra
        script: |
          CARGO_BIN="$HOME/.cargo/bin"
          export PATH="$CARGO_BIN:$PATH"
          cat <<EOT > expansions.yml
          cargo_bin: "$CARGO_BIN"
          working_dir: sql-engines-common-test-infra
          script_dir: ./evergreen/scripts
          prepare_shell: |
            set -o errexit
            export PATH="$PATH"
          EOT
    - command: expansions.update
      params:
        file: sql-engines-common-test-infra/expansions.yml

tasks:
  - name: test-rust
    commands:
      - func: "install rust toolchain"
      - func: "run rust tests"
        vars:
          description: "run rust unit tests"

buildvariants:
  - name: static-analysis
    display_name: "* Static Analysis"
    run_on: [ubuntu1804-test]
    tasks:
      - name: clippy
      - name: rustfmt
      - name: unused-dependencies

  - name: ubuntu1804-unit-test
    display_name: "Ubuntu 18.04 - Unit Tests"
    run_on: [ubuntu1804-test]
    tasks:
      - name: test-rust
